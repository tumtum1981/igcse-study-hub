<!DOCTYPE html>
<html lang="en">
<head>
    <style>html{visibility:hidden;opacity:0}</style>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Reset Password - IGCSE Study Hub</title>
    <link rel="preload" href="css/main.css" as="style">
    <link rel="preload" href="css/themes/undertale.css" as="style">
    <link rel="stylesheet" href="css/main.css">
    <link rel="stylesheet" href="css/themes/undertale.css" data-theme="true">
    <script src="js/theme-preload.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
</head>
<body>
    <nav class="nav-main">
        <div class="container nav-container">
            <a href="index.html" class="nav-brand">* IGCSE STUDY HUB</a>
            <button class="nav-toggle" aria-label="Toggle menu" aria-expanded="false">MENU</button>
            <ul class="nav-links">
                <li><a href="subjects/biology/index.html" class="nav-link" data-subject="biology">Biology</a></li>
                <li><a href="subjects/chemistry/index.html" class="nav-link" data-subject="chemistry">Chemistry</a></li>
                <li><a href="subjects/physics/index.html" class="nav-link" data-subject="physics">Physics</a></li>
                <li><a href="subjects/separate-biology/index.html" class="nav-link" data-subject="separate-bio">Separate Bio</a></li>
                <li><a href="tests/index.html" class="nav-link">Tests</a></li>
                <li><a href="formulas.html" class="nav-link">Formulas</a></li>
                <li class="theme-switcher">
                    <label class="theme-switcher__label" for="theme-select">Theme:</label>
                    <select class="theme-switcher__select" id="theme-select">
                        <option value="undertale">Undertale</option>
                        <option value="minecraft">Minecraft</option>
                        <option value="clean">Clean</option>
                    </select>
                </li>
            </ul>
        </div>
    </nav>

    <main class="container">
        <div class="auth-container">
            <div class="auth-box">
                <h2 style="text-align: center; margin-bottom: var(--spacing-lg);">* RESET PASSWORD</h2>

                <div class="auth-message" id="auth-message"></div>

                <!-- Loading State -->
                <div id="loading-state" style="text-align: center; padding: var(--spacing-lg);">
                    <p>* Verifying reset link...</p>
                </div>

                <!-- Reset Password Form -->
                <form class="auth-form" id="reset-form" style="display: none;">
                    <p class="form-hint" style="margin-bottom: var(--spacing-md);">Enter your new password below.</p>
                    <div class="form-group">
                        <label for="new-password">New Password</label>
                        <input type="password" id="new-password" name="password" required minlength="6" autocomplete="new-password">
                    </div>
                    <div class="form-group">
                        <label for="confirm-password">Confirm Password</label>
                        <input type="password" id="confirm-password" name="confirm-password" required minlength="6" autocomplete="new-password">
                    </div>
                    <button type="submit" class="auth-submit">UPDATE PASSWORD</button>
                </form>

                <!-- Invalid/Expired Link State -->
                <div id="invalid-state" style="display: none; text-align: center;">
                    <p style="margin-bottom: var(--spacing-lg);">* This reset link is invalid or has expired.</p>
                    <a href="login.html" class="auth-submit" style="display: inline-block;">BACK TO LOGIN</a>
                </div>

                <!-- Success State -->
                <div id="success-state" style="display: none; text-align: center;">
                    <p style="margin-bottom: var(--spacing-lg);">* Your password has been updated!</p>
                    <a href="login.html" class="auth-submit" style="display: inline-block;">GO TO LOGIN</a>
                </div>
            </div>
        </div>
    </main>

    <footer class="footer">
        <div class="container">
            <p>* The end of studying is just the beginning of knowledge.</p>
            <a href="about.html" class="footer-link">About</a>
        </div>
    </footer>

    <script src="js/main.js"></script>
    <script src="js/supabase-config.js"></script>
    <script src="js/auth.js"></script>
    <script>
        document.addEventListener('DOMContentLoaded', async () => {
            const loadingState = document.getElementById('loading-state');
            const resetForm = document.getElementById('reset-form');
            const invalidState = document.getElementById('invalid-state');
            const successState = document.getElementById('success-state');
            const message = document.getElementById('auth-message');

            function showMessage(text, isError = false) {
                message.textContent = '* ' + text;
                message.className = 'auth-message ' + (isError ? 'error' : 'success');
            }

            function showState(state) {
                loadingState.style.display = 'none';
                resetForm.style.display = 'none';
                invalidState.style.display = 'none';
                successState.style.display = 'none';
                state.style.display = '';
            }

            // Wait for auth to initialize
            await window.authManager.init();

            // Check if we have a valid session from the reset link
            // Supabase automatically handles the token exchange when the page loads
            const checkSession = async () => {
                // Small delay to allow Supabase to process the URL tokens
                await new Promise(resolve => setTimeout(resolve, 500));

                const user = window.authManager.getUser();

                if (user) {
                    // User is authenticated via reset link - show the form
                    showState(resetForm);
                } else {
                    // No valid session - invalid or expired link
                    showState(invalidState);
                }
            };

            // Listen for auth state changes (Supabase processes URL on load)
            window.authManager.onAuthChange((event, session) => {
                if (event === 'PASSWORD_RECOVERY') {
                    // This event fires when user clicks the reset link
                    showState(resetForm);
                }
            });

            // Check session after a short delay
            checkSession();

            // Handle form submission
            resetForm.addEventListener('submit', async (e) => {
                e.preventDefault();

                const newPassword = document.getElementById('new-password').value;
                const confirmPassword = document.getElementById('confirm-password').value;

                if (newPassword !== confirmPassword) {
                    showMessage('Passwords do not match', true);
                    return;
                }

                if (newPassword.length < 6) {
                    showMessage('Password must be at least 6 characters', true);
                    return;
                }

                showMessage('Updating password...');

                const result = await window.authManager.updatePassword(newPassword);

                if (result.success) {
                    showState(successState);
                    // Sign out so they can log in fresh with new password
                    await window.authManager.signOut();
                } else {
                    showMessage(result.error || 'Failed to update password', true);
                }
            });
        });
    </script>
</body>
</html>
