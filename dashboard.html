<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard - IGCSE Study Hub</title>
    <link rel="stylesheet" href="css/main.css">
    <link rel="stylesheet" href="css/themes/undertale.css" data-theme="true">
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
</head>
<body>
    <nav class="nav-main">
        <div class="container nav-container">
            <a href="index.html" class="nav-brand">* IGCSE STUDY HUB</a>
            <button class="nav-toggle" aria-label="Toggle menu" aria-expanded="false">MENU</button>
            <ul class="nav-links">
                <li><a href="subjects/biology/index.html" class="nav-link" data-subject="biology">Biology</a></li>
                <li><a href="subjects/chemistry/index.html" class="nav-link" data-subject="chemistry">Chemistry</a></li>
                <li><a href="subjects/physics/index.html" class="nav-link" data-subject="physics">Physics</a></li>
                <li><a href="subjects/separate-biology/index.html" class="nav-link" data-subject="separate-bio">Separate Bio</a></li>
                <li><a href="tests/index.html" class="nav-link">Tests</a></li>
                <li><a href="formulas.html" class="nav-link">Formulas</a></li>
                <li class="theme-switcher">
                    <label class="theme-switcher__label" for="theme-select">Theme:</label>
                    <select class="theme-switcher__select" id="theme-select">
                        <option value="undertale">Undertale</option>
                        <option value="minecraft">Minecraft</option>
                        <option value="clean">Clean</option>
                    </select>
                </li>
            </ul>
        </div>
    </nav>

    <header class="dashboard-header">
        <div class="container">
            <h1 class="dashboard-title">* YOUR PROGRESS</h1>
            <p class="dashboard-subtitle">Welcome back, <span id="dashboard-username">Student</span>!</p>
            <button class="logout-btn" id="logout-btn">LOGOUT</button>
        </div>
    </header>

    <main class="container">
        <!-- Not logged in message -->
        <div class="dashboard-login-prompt" id="login-prompt" style="display: none;">
            <p>* You need to be logged in to view your progress.</p>
            <a href="login.html" class="auth-submit">LOGIN</a>
        </div>

        <!-- Dashboard content -->
        <div id="dashboard-content">
            <!-- Progress Overview Cards -->
            <section class="dashboard-section">
                <h2>* OVERVIEW</h2>
                <div class="stats-grid">
                    <div class="stat-card">
                        <div class="stat-card__icon">&#9998;</div>
                        <div class="stat-card__value" id="stat-tests">0</div>
                        <div class="stat-card__label">Tests Completed</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-card__icon">&#9733;</div>
                        <div class="stat-card__value" id="stat-average">0%</div>
                        <div class="stat-card__label">Average Score</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-card__icon">&#10003;</div>
                        <div class="stat-card__value" id="stat-confident">0</div>
                        <div class="stat-card__label">Topics Confident</div>
                    </div>
                </div>
            </section>

            <!-- Subject Breakdown -->
            <section class="dashboard-section">
                <h2>* BY SUBJECT</h2>
                <div class="subject-progress-grid" id="subject-progress">
                    <p class="loading-text">Loading subject data...</p>
                </div>
            </section>

            <!-- Recent Tests -->
            <section class="dashboard-section">
                <h2>* RECENT TESTS</h2>
                <div class="test-history" id="test-history">
                    <p class="loading-text">Loading test history...</p>
                </div>
            </section>

            <!-- Personal Bests -->
            <section class="dashboard-section">
                <h2>* PERSONAL BESTS</h2>
                <div class="personal-bests" id="personal-bests">
                    <p class="loading-text">Loading personal bests...</p>
                </div>
            </section>

            <!-- Confidence Summary -->
            <section class="dashboard-section">
                <h2>* TOPIC CONFIDENCE</h2>
                <div class="confidence-summary" id="confidence-summary">
                    <p class="loading-text">Loading confidence data...</p>
                </div>
            </section>
        </div>
    </main>

    <footer class="footer">
        <div class="container">
            <p>* The end of studying is just the beginning of knowledge.</p>
            <a href="about.html" class="footer-link">About</a>
        </div>
    </footer>

    <script src="js/main.js"></script>
    <script src="js/supabase-config.js"></script>
    <script src="js/auth.js"></script>
    <script src="js/progress.js"></script>
    <script>
        // Dashboard functionality
        document.addEventListener('DOMContentLoaded', async () => {
            const loginPrompt = document.getElementById('login-prompt');
            const dashboardContent = document.getElementById('dashboard-content');
            const logoutBtn = document.getElementById('logout-btn');
            const usernameDisplay = document.getElementById('dashboard-username');

            // Wait for auth to initialize
            await waitForAuth();

            // Check login status
            if (!window.authManager.isLoggedIn()) {
                loginPrompt.style.display = '';
                dashboardContent.style.display = 'none';
                return;
            }

            // Update username
            const profile = window.authManager.getProfile();
            if (profile) {
                usernameDisplay.textContent = profile.username;
            }

            // Load dashboard data
            await loadDashboard();

            // Logout handler
            logoutBtn.addEventListener('click', async () => {
                await window.authManager.signOut();
                window.location.href = 'index.html';
            });
        });

        function waitForAuth() {
            return new Promise(resolve => {
                const check = () => {
                    if (window.authManager && window.authManager.initialized) {
                        resolve();
                    } else {
                        setTimeout(check, 50);
                    }
                };
                check();
            });
        }

        async function loadDashboard() {
            // Load progress summary
            const summary = await window.progressManager.getProgressSummary();

            // Update stats cards
            document.getElementById('stat-tests').textContent = summary.testsCompleted;
            document.getElementById('stat-average').textContent = summary.averageScore + '%';
            document.getElementById('stat-confident').textContent = summary.topicsConfident;

            // Load subject progress
            loadSubjectProgress(summary.bySubject);

            // Load test history
            const history = await window.progressManager.getTestHistory(10);
            loadTestHistory(history);

            // Load personal bests
            const bests = await window.progressManager.getPersonalBests();
            loadPersonalBests(bests);

            // Load confidence summary
            const confidence = await window.progressManager.getAllConfidence();
            loadConfidenceSummary(confidence);
        }

        function loadSubjectProgress(bySubject) {
            const container = document.getElementById('subject-progress');

            const subjects = ['biology', 'chemistry', 'physics', 'separate-biology'];
            const subjectNames = {
                'biology': 'Biology',
                'chemistry': 'Chemistry',
                'physics': 'Physics',
                'separate-biology': 'Separate Bio'
            };

            let html = '<div class="subject-progress-cards">';

            subjects.forEach(subject => {
                const data = bySubject[subject] || { tests: 0, average: 0 };
                html += `
                    <div class="subject-progress-card subject-progress-card--${subject}">
                        <h3>${subjectNames[subject]}</h3>
                        <div class="subject-progress-stat">
                            <span class="subject-progress-value">${data.tests}</span>
                            <span class="subject-progress-label">tests</span>
                        </div>
                        <div class="subject-progress-stat">
                            <span class="subject-progress-value">${data.average || 0}%</span>
                            <span class="subject-progress-label">average</span>
                        </div>
                    </div>
                `;
            });

            html += '</div>';
            container.innerHTML = html;
        }

        function loadTestHistory(history) {
            const container = document.getElementById('test-history');

            if (history.length === 0) {
                container.innerHTML = '<p class="no-data">* No tests completed yet. Take a test to see your progress!</p>';
                return;
            }

            let html = '<table class="history-table"><thead><tr><th>Date</th><th>Test</th><th>Score</th></tr></thead><tbody>';

            history.forEach(test => {
                const date = new Date(test.completed_at).toLocaleDateString();
                const testName = formatTestId(test.test_id);
                const scoreClass = test.percentage >= 70 ? 'good' : test.percentage >= 50 ? 'okay' : 'poor';

                html += `
                    <tr>
                        <td>${date}</td>
                        <td>${testName}</td>
                        <td class="score-${scoreClass}">${test.score}/${test.total} (${test.percentage}%)</td>
                    </tr>
                `;
            });

            html += '</tbody></table>';
            container.innerHTML = html;
        }

        function loadPersonalBests(bests) {
            const container = document.getElementById('personal-bests');

            const testIds = Object.keys(bests);
            if (testIds.length === 0) {
                container.innerHTML = '<p class="no-data">* No personal bests yet. Keep practicing!</p>';
                return;
            }

            let html = '<div class="bests-grid">';

            testIds.forEach(testId => {
                const percentage = bests[testId];
                const scoreClass = percentage >= 90 ? 'excellent' : percentage >= 70 ? 'good' : percentage >= 50 ? 'okay' : 'poor';

                html += `
                    <div class="best-card best-card--${scoreClass}">
                        <div class="best-card__test">${formatTestId(testId)}</div>
                        <div class="best-card__score">${percentage}%</div>
                    </div>
                `;
            });

            html += '</div>';
            container.innerHTML = html;
        }

        function loadConfidenceSummary(confidence) {
            const container = document.getElementById('confidence-summary');

            const topicIds = Object.keys(confidence);
            if (topicIds.length === 0) {
                container.innerHTML = '<p class="no-data">* No topics rated yet. Rate your confidence on topic pages!</p>';
                return;
            }

            // Group topics by level
            let groups = {
                'confident': [],
                'learning': [],
                'need-practice': []
            };

            topicIds.forEach(id => {
                groups[confidence[id]].push(id);
            });

            function buildTopicList(topics, level) {
                if (topics.length === 0) return '';
                return `
                    <div class="confidence-topics" id="topics-${level}" style="display: none;">
                        <ul class="confidence-topics__list">
                            ${topics.map(id => `<li><a href="${getTopicUrl(id)}">${formatTopicId(id)}</a></li>`).join('')}
                        </ul>
                    </div>
                `;
            }

            let html = `
                <div class="confidence-bars">
                    <div class="confidence-bar confidence-bar--clickable" data-level="confident" onclick="toggleTopicList('confident')">
                        <span class="confidence-bar__label">Confident</span>
                        <div class="confidence-bar__track">
                            <div class="confidence-bar__fill confident" style="width: ${(groups.confident.length / topicIds.length) * 100}%"></div>
                        </div>
                        <span class="confidence-bar__count">${groups.confident.length}</span>
                        <span class="confidence-bar__toggle">&#9660;</span>
                    </div>
                    ${buildTopicList(groups.confident, 'confident')}

                    <div class="confidence-bar confidence-bar--clickable" data-level="learning" onclick="toggleTopicList('learning')">
                        <span class="confidence-bar__label">Learning</span>
                        <div class="confidence-bar__track">
                            <div class="confidence-bar__fill learning" style="width: ${(groups.learning.length / topicIds.length) * 100}%"></div>
                        </div>
                        <span class="confidence-bar__count">${groups.learning.length}</span>
                        <span class="confidence-bar__toggle">&#9660;</span>
                    </div>
                    ${buildTopicList(groups.learning, 'learning')}

                    <div class="confidence-bar confidence-bar--clickable" data-level="need-practice" onclick="toggleTopicList('need-practice')">
                        <span class="confidence-bar__label">Need Practice</span>
                        <div class="confidence-bar__track">
                            <div class="confidence-bar__fill need-practice" style="width: ${(groups['need-practice'].length / topicIds.length) * 100}%"></div>
                        </div>
                        <span class="confidence-bar__count">${groups['need-practice'].length}</span>
                        <span class="confidence-bar__toggle">&#9660;</span>
                    </div>
                    ${buildTopicList(groups['need-practice'], 'need-practice')}
                </div>
            `;

            container.innerHTML = html;
        }

        function toggleTopicList(level) {
            const topicList = document.getElementById('topics-' + level);
            const bar = document.querySelector(`.confidence-bar[data-level="${level}"]`);

            if (topicList) {
                const isVisible = topicList.style.display !== 'none';
                topicList.style.display = isVisible ? 'none' : 'block';
                bar.classList.toggle('expanded', !isVisible);
            }
        }

        // Topic lookup table: maps topic IDs to names and filenames
        const TOPIC_DATA = {
            // Biology Block 1
            'b1-1-1': { name: 'Cells', file: '01-cells' },
            'b1-2-1': { name: 'Specialised Cells', file: '02-specialised-cells' },
            'b1-3-1': { name: 'Magnification', file: '03-magnification' },
            'b1-4-1': { name: 'Living Organisms', file: '04-living-organisms' },
            'b1-5-1': { name: 'Prokaryotic Cells', file: '05-prokaryotic-cells' },
            // Biology Block 2
            'b2-1-1': { name: 'Size of Cells', file: '01-size-of-cells' },
            'b2-2-1': { name: 'Diffusion', file: '02-diffusion' },
            'b2-3-1': { name: 'Osmosis', file: '03-osmosis' },
            'b2-4-1': { name: 'Osmosis Practical', file: '04-osmosis-practical' },
            'b2-5-1': { name: 'Active Transport', file: '05-active-transport' },
            // Biology Block 3
            'b3-1-1': { name: 'Biological Molecules', file: '01-biological-molecules' },
            'b3-2-1': { name: 'Digestive System', file: '02-digestive-system' },
            'b3-3-1': { name: 'Enzymes', file: '03-enzymes' },
            // Chemistry Block 1
            'c1-1-1': { name: 'Atoms, Elements & Compounds', file: '01-atoms-elements-compounds' },
            'c1-2-1': { name: 'States of Matter', file: '02-states-of-matter' },
            'c1-3-1': { name: 'Atomic Structure', file: '03-atomic-structure' },
            'c1-4-1': { name: 'Electron Shells', file: '04-electron-shells' },
            'c1-5-1': { name: 'Ions & Isotopes', file: '05-ions-isotopes' },
            // Chemistry Block 2
            'c2-1-1': { name: 'State Changes', file: '01-state-changes' },
            'c2-2-1': { name: 'Ionic Bonding', file: '02-ionic-bonding' },
            'c2-3-1': { name: 'Covalent Bonding', file: '03-covalent-bonding' },
            'c2-4-1': { name: 'Metallic Bonding', file: '04-metallic-bonding' },
            'c2-5-1': { name: 'Giant Covalent', file: '05-giant-covalent' },
            // Chemistry Block 3
            'c3-1-1': { name: 'Conservation of Mass', file: '01-conservation-of-mass' },
            'c3-2-1': { name: 'Conservation Calculations', file: '02-conservation-calculations' },
            'c3-3-1': { name: 'Representing Reactions', file: '03-representing-reactions' },
            'c3-4-1': { name: 'Balancing Equations', file: '04-balancing-equations' },
            // Physics Block 1
            'p1-1-1': { name: 'Speed, Distance & Time', file: '01-speed-distance-time' },
            'p1-2-1': { name: 'Distance-Time Graphs', file: '02-distance-time-graphs' },
            'p1-3-1': { name: 'Velocity-Time Graphs', file: '03-velocity-time-graphs' },
            'p1-4-1': { name: 'Gravitational Force', file: '04-gravitational-force' },
            'p1-5-1': { name: 'Work Done', file: '05-work-done' },
            // Physics Block 2
            'p2-1-1': { name: 'Density', file: '01-density' },
            'p2-2-1': { name: 'Forces', file: '02-forces' },
            'p2-3-1': { name: 'Resultant Forces', file: '03-resultant-forces' },
            'p2-4-1': { name: 'Moments', file: '04-moments' },
            'p2-5-1': { name: 'Newton\'s Second Law', file: '05-newtons-second-law' },
            // Physics Block 3
            'p3-1-1': { name: 'Energy Stores', file: '01-energy-stores' },
            'p3-2-1': { name: 'Energy Resources', file: '02-energy-resources' },
            // Separate Biology Block 1
            'sb1-1-1': { name: 'Features of Organisms', file: '01-features-of-organisms' },
            'sb1-2-1': { name: 'Species & Binomial', file: '02-species-binomial' },
            'sb1-3-1': { name: 'Evolutionary Trees', file: '03-evolutionary-trees' },
            'sb1-4-1': { name: 'Dichotomous Keys', file: '04-dichotomous-keys' },
            'sb1-5-1': { name: 'Plant Classification', file: '05-plant-classification' }
        };

        // Subject code to full name and folder
        const SUBJECT_INFO = {
            'b': { name: 'Biology', folder: 'biology' },
            'c': { name: 'Chemistry', folder: 'chemistry' },
            'p': { name: 'Physics', folder: 'physics' },
            'sb': { name: 'Separate Biology', folder: 'separate-biology' }
        };

        function parseTopicId(topicId) {
            // Parse topic ID like "b1-2-1" or "sb1-3-1"
            const match = topicId.match(/^(sb|b|c|p)(\d+)-(\d+)-(\d+)$/);
            if (!match) return null;
            return {
                subjectCode: match[1],
                blockNum: match[2],
                topicNum: match[3]
            };
        }

        function formatTopicId(topicId) {
            // Look up in topic data first
            const topicData = TOPIC_DATA[topicId];
            const parsed = parseTopicId(topicId);

            if (!parsed) return topicId;

            const subjectInfo = SUBJECT_INFO[parsed.subjectCode];
            const subjectName = subjectInfo ? subjectInfo.name : parsed.subjectCode.toUpperCase();
            const topicName = topicData ? topicData.name : `Topic ${parsed.topicNum}`;

            return `${subjectName} - Block ${parsed.blockNum} - ${topicName}`;
        }

        function getTopicUrl(topicId) {
            const topicData = TOPIC_DATA[topicId];
            const parsed = parseTopicId(topicId);

            if (!parsed) return 'index.html';

            const subjectInfo = SUBJECT_INFO[parsed.subjectCode];
            const folder = subjectInfo ? subjectInfo.folder : parsed.subjectCode;
            const filename = topicData ? topicData.file : `0${parsed.topicNum}-topic`;

            return `subjects/${folder}/block-${parsed.blockNum}/${filename}.html`;
        }

        function formatTestId(testId) {
            // Convert test-id like "biology-block-1-test-1" to "Biology Block 1 Test 1"
            return testId
                .split('-')
                .map(word => word.charAt(0).toUpperCase() + word.slice(1))
                .join(' ');
        }
    </script>
</body>
</html>
